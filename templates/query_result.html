<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>選課幫手 - 已選課程</title>
    {% include "font.html" %}
    <style>
        /* Show it is fixed to the top */
        body {
            padding-top: 4.5rem;
        }

        #warning li {
            padding-bottom: 0.5rem;
        }

        #warning li:last-child {
            padding-bottom: 0;
        }
    </style>
</head>
<body>
{% include 'navbar.html' %}
<div class="container min-vh-100">
    <div>
        <p id="title" class="text-center fs-2 lh-lg" style="color: var(--bs-purple)">已選結果</p>
    </div>
    <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover text-nowrap text-center align-middle">
            <caption class="caption-top sticky-top" style="padding: 1rem;">
                <span id="update_time" class="badge bg-secondary position-absolute top-50 end-0 translate-middle-y">
                </span>
            </caption>
            <thead class="table-info">
            <tr>
                <th scope="col" style="width: 4%">選擇</th>
                <th scope="col" style="width: 5%; min-width: 5em; max-width: 5em">班級</th>
                <th scope="col" style="width: 3%">選課<br>代號</th>
                <th scope="col" style="width: 10%; min-width: 7em">類別</th>
                <th scope="col" style="width: 20%; min-width: 10em">科目</th>
                <th scope="col" style="width: 3%">學分</th>
                <th scope="col" style="width: 3%">學年<br>學期</th>
                <th scope="col" style="width: 3%">必修<br>選修</th>
                <th scope="col" style="width: 3%">授課<br>時數</th>
                <th scope="col" style="width: 5%" colspan="3">人數<br>上限 / 下限 / 已選</th>
                <th scope="col" style="width: 4%">校區</th>
                <th scope="col" style="width: 5%">授課教師</th>
                <th scope="col" style="width: 6%">上課時間</th>
                <th scope="col" style="width: 4%">備註</th>
            </tr>
            </thead>
            <tbody id="data">
            <tr>
                <td colspan="17" class="col-md-auto position-relative text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
                <td id="class_count" class="table" colspan="17">總共列出了 堂課</td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
{% include 'footerjs.html' %}
{% include 'query_js.html' %}
<script>
    (() => {
        $.getJSON("{{ url_for("api.get_query") }}")
            .done((data) => {
                let node = $("#data");
                node.empty();

                for (const datum of data) {
                    let s_te = ``, s_ti = ``, s_no = ``;

                    for (const [i, teacher] of datum.teachers.entries()) {
                        s_te += teacher.name;
                        if (i !== datum.teachers.length - 1) {
                            s_te += "<br>";
                        }
                    }

                    for (const [i, time] of datum.times.entries()) {
                        s_ti += time[0];
                        s_ti += ' <span>';
                        for (const [j, value] of time[1].entries()) {
                            s_ti += value;
                            if (j !== time[1].length - 1) {
                                s_ti += ', ';
                            }
                        }
                        if (i !== datum.times.length - 1) {
                            s_ti += '<br>';
                        }
                        s_ti += '</span>';
                    }

                    if (datum.notes !== ' ') {
                        s_no += `<div class="text-center" data-bs-toggle="tooltip"
                                 data-bs-placement="top" title="${datum.notes}">
                                <div class="bi bi-exclamation-circle"></div>
                            </div>`
                    }

                    if (datum.limit) {
                        s_no += `<form name="notes" method="post" target="new"
                                  action="http://shcourse.utaipei.edu.tw/utaipei/ag_pro/ag203_limit.jsp">
                                <input type="hidden" name="ls_year" value="{{ year }}">
                                <input type="hidden" name="ls_sms" value="{{ semester }}">
                                <input type="hidden" name="data" value="${datum.id}">
                                <a href="#" class="link" onclick="this.parentNode.submit();">
                                    限修
                                </a>
                            </form>`
                    }

                    appnodes = `<tr style="height: 3em">
                        <th scope="col" id="${datum.id}">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="remove_query(this.parentNode)">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                        </th>
                        <td class="text-wrap">${datum.class_name}</td>
                        <td>
                            <form name="form" method="post" target="new"
                                  action="http://shcourse.utaipei.edu.tw/utaipei/ag_pro/ag064_print.jsp">
                                <input type="hidden" name="arg01" value="{{ year }}">
                                <input type="hidden" name="arg02" value="{{ semester }}">
                                <input type="hidden" name="arg04" value="${datum.syllabus}">
                                <a href="#" class="link-primary" onclick="this.parentNode.submit();">${datum.id}</a>
                            </form>
                        </td>
                        <td class="text-wrap">${datum.category}</td>
                        <td class="text-wrap">
                            <div data-bs-toggle="tooltip" data-bs-placement="top" title="${datum.english_name}">
                                ${datum.chinese_name}
                            </div>
                        </td>
                        <td>${datum.points}</td>
                        <td>${datum.full_half}</td>
                        <td>${datum.req_select}</td>
                        <td>${datum.hours}</td>
                        <td>${datum.enrolled_max}</td>
                        <td>${datum.enrolled_min}</td>
                        <td>${datum.enrolled_current}</td>
                        <td>${datum.campus}</td>
                        <td>${s_te}</td>
                        <td>${s_ti}</td>
                        <td>${s_no}</td>
                    </tr>`
                    node.append(appnodes);
                }

                counts = $("#class_count");
                counts.text("總共列出了 " + data.length + " 堂課");

                // reload bootstrap
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
            })
            .fail(() => {

            });
    })();
</script>
</body>
</html>